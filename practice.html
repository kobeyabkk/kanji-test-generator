<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>漢字手書き練習 | プログラミングのKOBEYA</title>
    
    <!-- ファビコン -->
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="shortcut icon" href="/icons/favicon.ico">
    
    <!-- PWA設定 -->
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="小学生向け漢字手書き練習アプリ">
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOS対応 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="漢字練習">
    <link rel="apple-touch-icon" href="/icons/icon-512x512.png">
    
    <link rel="stylesheet" href="practice.css">
</head>
<body>
    <div class="container">
        <header>
            <h1 id="mode-title">✏️ 漢字練習モード</h1>
            <p class="subtitle" id="mode-subtitle">漢字をなぞって練習しましょう</p>
        </header>

        <div class="controls-top">
            <div class="pen-settings">
                <div class="pen-control">
                    <label for="pen-width">ペン太さ:</label>
                    <input type="range" id="pen-width" min="2" max="20" value="6" step="1">
                    <span id="pen-width-value">6px</span>
                </div>
                
                <div class="pen-control">
                    <label for="pen-color">色:</label>
                    <input type="color" id="pen-color" value="#000000">
                </div>
                
                <div class="pen-control">
                    <label for="eraser-width">消しゴム太さ:</label>
                    <input type="range" id="eraser-width" min="5" max="40" value="20" step="1">
                    <span id="eraser-width-value">20px</span>
                </div>
                
                <button id="eraser-btn" class="btn btn-eraser">🧹 消しゴム</button>
            </div>
            
            <div class="action-buttons">
                <button id="clear-btn" class="btn btn-secondary">🗑️ 全て消す</button>
                <button id="screenshot-btn" class="btn btn-secondary">📸 スクショ保存</button>
                <button id="mode-switch-btn" class="btn btn-primary">練習完了 → テスト開始</button>
            </div>
        </div>

        <!-- 練習モード画面 -->
        <div id="practice-screen" class="practice-screen">
            <div class="practice-grid" id="practice-grid"></div>
        </div>

        <!-- テストモード画面 -->
        <div id="test-screen" class="test-screen hidden">
            <div class="test-grid" id="test-grid"></div>
        </div>

        <div class="navigation">
            <button id="back-btn" class="btn btn-outline">← 設定に戻る</button>
            <button id="regenerate-btn" class="btn btn-outline">🔄 別の問題を生成</button>
            <button id="restart-btn" class="btn btn-outline">🗑️ 最初から</button>
        </div>
    </div>

    <script src="practice.js"></script>
    
    <!-- 🔧 デバッグ用：Eruda（iPad単体でコンソールを確認） -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>
        // 常にErudaを起動（iPadデバッグ用）
        eruda.init();
        console.log('🔧 デバッグモード: Erudaを起動しました');
    </script>
    
    <!-- 🔔 アップデート通知UI -->
    <div id="update-notification" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 10000; font-family: 'UD Digi Kyokasho N-R', 'UDデジタル教科書体', '游教科書体', 'Yu Kyokasho', '游明朝', 'Yu Mincho', serif; text-align: center;">
        <div style="margin-bottom: 10px; font-size: 16px; font-weight: bold;">🎉 新しいバージョンが利用可能です</div>
        <button id="update-btn" style="background: white; color: #667eea; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px;">今すぐ更新</button>
    </div>

    <!-- PWA Service Worker登録 + アップデート検出 -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => {
                    console.log('✅ Service Worker登録成功');
                    
                    // アップデート検出
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('🔔 新しいバージョンが利用可能です');
                                // アップデート通知を表示
                                document.getElementById('update-notification').style.display = 'block';
                                
                                // 更新ボタンのクリックイベント
                                document.getElementById('update-btn').addEventListener('click', () => {
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                    window.location.reload();
                                });
                            }
                        });
                    });
                    
                    // Service Workerが更新されたらリロード
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        console.log('🔄 Service Workerが更新されました');
                        window.location.reload();
                    });
                })
                .catch(err => console.error('❌ Service Worker登録失敗:', err));
        }
    </script>
</body>
</html>
