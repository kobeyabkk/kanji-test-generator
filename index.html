<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小学生漢字練習プリント生成</title>
    <!-- Version 1.1.0 - 細長い画面対応 -->
    
    <!-- ファビコン -->
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="shortcut icon" href="/icons/favicon.ico">
    
    <!-- PWA設定 -->
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="小学生向け漢字学習アプリ。プリント生成・手書き練習機能付き。">
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOS対応 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="漢字テスト">
    <link rel="apple-touch-icon" href="/icons/icon-512x512.png">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 設定画面 -->
    <div id="settings-screen">
        <div class="container">
            <h1>📝 小学生漢字練習プリント生成</h1>
            <p class="subtitle">A4横向き・縦書き対応 | 練習欄＋テスト欄</p>
            
            <!-- 🆕 モード選択 -->
            <div class="mode-selection">
                <label class="mode-label">📋 テストモード選択：</label>
                <div class="mode-options">
                    <label class="mode-option">
                        <input type="radio" name="test-mode" value="practice" checked>
                        <span class="mode-text">✍️ 練習＋テスト（同じ10問で練習→テスト）</span>
                    </label>
                    <label class="mode-option">
                        <input type="radio" name="test-mode" value="test10">
                        <span class="mode-text">📝 テスト10問（書きテストのみ）</span>
                    </label>
                    <label class="mode-option">
                        <input type="radio" name="test-mode" value="test20">
                        <span class="mode-text">📝 テスト20問（書きテスト×2）</span>
                    </label>
                </div>
            </div>
            
            <div class="settings-form">
                <!-- 左側: 漢字選択セクション -->
                <div class="left-section">
                <div class="kanji-selection-section">
                    <h2 class="kanji-selection-header" id="kanji-selection-toggle">
                        📚 出題する漢字を選択 <span class="toggle-icon">▼</span>
                    </h2>
                    
                    <div class="kanji-selection-content" id="kanji-selection-content">
                    <!-- 🆕 検索バー -->
                    <div class="kanji-search-container">
                        <input type="text" id="kanji-search-input" class="kanji-search-input" placeholder="🔍 漢字を検索..." maxlength="1">
                        <button id="kanji-search-clear" class="search-clear-btn" title="クリア">✕</button>
                    </div>
                    
                    <!-- タブ -->
                    <div class="kanji-tabs">
                        <button class="kanji-tab active" data-grade="1">小1（<span id="grade1-selected-count">80</span>/80）</button>
                        <button class="kanji-tab" data-grade="2">小2（<span id="grade2-selected-count">160</span>/160）</button>
                        <button class="kanji-tab" data-grade="3">小3（<span id="grade3-selected-count">200</span>/200）</button>
                        <button class="kanji-tab" data-grade="4">小4（<span id="grade4-selected-count">202</span>/202）</button>
                        <button class="kanji-tab" data-grade="5">小5（<span id="grade5-selected-count">193</span>/193）</button>
                        <button class="kanji-tab" data-grade="6">小6（<span id="grade6-selected-count">191</span>/191）</button>
                    </div>
                    
                    <!-- タブコンテンツ -->
                    <div class="kanji-tab-content">
                        <!-- 小1漢字選択 -->
                        <div class="kanji-tab-panel active" data-grade="1">
                            <div class="kanji-controls">
                                <button class="btn-control" id="select-all-grade1">✓ 全選択</button>
                                <button class="btn-control" id="deselect-all-grade1">✗ 全解除</button>
                                <button class="btn-control" id="invert-grade1">⇄ 反転</button>
                            </div>
                            <div class="kanji-grid" id="kanji-grid-grade1">
                                <!-- JavaScriptで生成 -->
                            </div>
                        </div>
                        
                        <!-- 小2漢字選択 -->
                        <div class="kanji-tab-panel" data-grade="2">
                            <div class="kanji-controls">
                                <button class="btn-control" id="select-all-grade2">✓ 全選択</button>
                                <button class="btn-control" id="deselect-all-grade2">✗ 全解除</button>
                                <button class="btn-control" id="invert-grade2">⇄ 反転</button>
                            </div>
                            <div class="kanji-grid" id="kanji-grid-grade2">
                                <!-- JavaScriptで生成 -->
                            </div>
                        </div>
                        
                        <!-- 小3漢字選択 -->
                        <div class="kanji-tab-panel" data-grade="3">
                            <div class="kanji-controls">
                                <button class="btn-control" id="select-all-grade3">✓ 全選択</button>
                                <button class="btn-control" id="deselect-all-grade3">✗ 全解除</button>
                                <button class="btn-control" id="invert-grade3">⇄ 反転</button>
                            </div>
                            <div class="kanji-grid" id="kanji-grid-grade3">
                                <!-- JavaScriptで生成 -->
                            </div>
                        </div>
                        
                        <!-- 小4漢字選択 -->
                        <div class="kanji-tab-panel" data-grade="4">
                            <div class="kanji-controls">
                                <button class="btn-control" id="select-all-grade4">✓ 全選択</button>
                                <button class="btn-control" id="deselect-all-grade4">✗ 全解除</button>
                                <button class="btn-control" id="invert-grade4">⇄ 反転</button>
                            </div>
                            <div class="kanji-grid" id="kanji-grid-grade4">
                                <!-- JavaScriptで生成 -->
                            </div>
                        </div>
                        
                        <!-- 小5漢字選択 -->
                        <div class="kanji-tab-panel" data-grade="5">
                            <div class="kanji-controls">
                                <button class="btn-control" id="select-all-grade5">✓ 全選択</button>
                                <button class="btn-control" id="deselect-all-grade5">✗ 全解除</button>
                                <button class="btn-control" id="invert-grade5">⇄ 反転</button>
                            </div>
                            <div class="kanji-grid" id="kanji-grid-grade5">
                                <!-- JavaScriptで生成 -->
                            </div>
                        </div>
                        
                        <!-- 小6漢字選択 -->
                        <div class="kanji-tab-panel" data-grade="6">
                            <div class="kanji-controls">
                                <button class="btn-control" id="select-all-grade6">✓ 全選択</button>
                                <button class="btn-control" id="deselect-all-grade6">✗ 全解除</button>
                                <button class="btn-control" id="invert-grade6">⇄ 反転</button>
                            </div>
                            <div class="kanji-grid" id="kanji-grid-grade6">
                                <!-- JavaScriptで生成 -->
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                </div><!-- 左側セクション終了 -->

                <!-- 右側: 設定項目セクション -->
                <div class="right-section">
                
                <!-- 🆕 最近出た漢字の除外設定 -->
                <div class="form-group">
                    <label for="exclude-recent">最近出た漢字を除外</label>
                    <select id="exclude-recent" class="select-input">
                        <option value="0" selected>除外しない</option>
                        <option value="10">直近10問を除外</option>
                        <option value="20">直近20問を除外</option>
                        <option value="30">直近30問を除外</option>
                        <option value="50">直近50問を除外</option>
                    </select>
                    <p class="note">前回までに出題した漢字を除外します</p>
                </div>

                <!-- 学年別問題数設定 -->
                <div class="form-group">
                    <label>学年別問題数設定</label>
                    <div class="grade-question-settings">
                        <div class="grade-question-row">
                            <span class="grade-label">小1 (80字)</span>
                            <select id="grade1-count" class="grade-count-select">
                                <option value="0">0問</option>
                                <option value="1">1問</option>
                                <option value="2">2問</option>
                                <option value="3" selected>3問</option>
                                <option value="4">4問</option>
                                <option value="5">5問</option>
                                <option value="6">6問</option>
                                <option value="7">7問</option>
                                <option value="8">8問</option>
                                <option value="9">9問</option>
                                <option value="10">10問</option>
                                <option value="15">15問</option>
                                <option value="20">20問</option>
                            </select>
                        </div>
                        <div class="grade-question-row">
                            <span class="grade-label">小2 (160字)</span>
                            <select id="grade2-count" class="grade-count-select">
                                <option value="0">0問</option>
                                <option value="1">1問</option>
                                <option value="2">2問</option>
                                <option value="3" selected>3問</option>
                                <option value="4">4問</option>
                                <option value="5">5問</option>
                                <option value="6">6問</option>
                                <option value="7">7問</option>
                                <option value="8">8問</option>
                                <option value="9">9問</option>
                                <option value="10">10問</option>
                                <option value="15">15問</option>
                                <option value="20">20問</option>
                            </select>
                        </div>
                        <div class="grade-question-row">
                            <span class="grade-label">小3 (200字)</span>
                            <select id="grade3-count" class="grade-count-select">
                                <option value="0">0問</option>
                                <option value="1">1問</option>
                                <option value="2">2問</option>
                                <option value="3">3問</option>
                                <option value="4" selected>4問</option>
                                <option value="5">5問</option>
                                <option value="6">6問</option>
                                <option value="7">7問</option>
                                <option value="8">8問</option>
                                <option value="9">9問</option>
                                <option value="10">10問</option>
                                <option value="15">15問</option>
                                <option value="20">20問</option>
                            </select>
                        </div>
                        <div class="grade-question-row">
                            <span class="grade-label">小4 (202字)</span>
                            <select id="grade4-count" class="grade-count-select">
                                <option value="0" selected>0問</option>
                                <option value="1">1問</option>
                                <option value="2">2問</option>
                                <option value="3">3問</option>
                                <option value="4">4問</option>
                                <option value="5">5問</option>
                                <option value="6">6問</option>
                                <option value="7">7問</option>
                                <option value="8">8問</option>
                                <option value="9">9問</option>
                                <option value="10">10問</option>
                                <option value="15">15問</option>
                                <option value="20">20問</option>
                            </select>
                        </div>
                        <div class="grade-question-row">
                            <span class="grade-label">小5 (193字)</span>
                            <select id="grade5-count" class="grade-count-select">
                                <option value="0" selected>0問</option>
                                <option value="1">1問</option>
                                <option value="2">2問</option>
                                <option value="3">3問</option>
                                <option value="4">4問</option>
                                <option value="5">5問</option>
                                <option value="6">6問</option>
                                <option value="7">7問</option>
                                <option value="8">8問</option>
                                <option value="9">9問</option>
                                <option value="10">10問</option>
                                <option value="15">15問</option>
                                <option value="20">20問</option>
                            </select>
                        </div>
                        <div class="grade-question-row">
                            <span class="grade-label">小6 (191字)</span>
                            <select id="grade6-count" class="grade-count-select">
                                <option value="0" selected>0問</option>
                                <option value="1">1問</option>
                                <option value="2">2問</option>
                                <option value="3">3問</option>
                                <option value="4">4問</option>
                                <option value="5">5問</option>
                                <option value="6">6問</option>
                                <option value="7">7問</option>
                                <option value="8">8問</option>
                                <option value="9">9問</option>
                                <option value="10">10問</option>
                                <option value="15">15問</option>
                                <option value="20">20問</option>
                            </select>
                        </div>
                    </div>
                    <p class="note question-count-status" id="question-count-status">
                        <span id="mode-name">練習＋テスト</span>モード: 
                        合計 <span id="current-total">20</span>問 / 目標 <span id="target-total">20</span>問
                        <span id="count-validation" class="validation-ok">✓</span>
                    </p>
                </div>

                <div class="form-group">
                    <label for="student-name">生徒名（任意）</label>
                    <input type="text" id="student-name" placeholder="例：山田太郎">
                </div>

                <div class="form-group">
                    <label for="print-date">実施日</label>
                    <input type="date" id="print-date">
                </div>

                <button id="generate-btn" class="btn-primary">プリント生成</button>
                <button id="practice-btn" class="btn-secondary" style="margin-top: 15px;">✏️ 手書き練習</button>
                
                <p style="text-align: center; margin-top: 15px;">
                    <a href="editor.html" target="_blank" style="color: #667eea; text-decoration: none; font-size: 14px;">
                        📝 漢字データ編集画面を開く
                    </a>
                </p>
                
                </div><!-- 右側セクション終了 -->
            </div><!-- settings-form終了 -->
        </div>
    </div>

    <!-- 印刷用画面（A4横向き・縦書き） -->
    <div id="print-screen" class="hidden">
        <div class="print-container">
            <!-- ヘッダー情報 -->
            <div class="print-header">
                <h1 class="print-title">小2漢字練習プリント</h1>
                <div class="header-info">
                    <span class="student-name-field">名前：<span id="display-name">__________</span></span>
                    <span class="date-field">日付：<span id="display-date">____年____月____日</span></span>
                </div>
            </div>

            <!-- 🆕 4つのセクションはJavaScriptで動的に生成 -->

            <!-- フッター -->
            <div class="print-footer">
                © 2025 プログラミングのKOBEYA
            </div>
        </div>

        <div class="print-controls">
            <button id="edit-mode-btn" class="btn-edit">✏️ 編集モード</button>
            <button id="save-edit-btn" class="btn-save hidden">💾 編集を保存</button>
            <button id="toggle-answer-btn" class="btn-toggle">👁️ 解答を表示</button>
            <button id="print-btn" class="btn-primary">🖨️ 印刷・PDF保存</button>
            <button id="back-btn" class="btn-secondary">← 設定に戻る</button>
            <button id="regenerate-btn" class="btn-secondary">🔄 別の問題を生成</button>
        </div>
        
        <!-- 🆕 解答セクション -->
        <div id="answer-section" class="answer-section hidden"></div>
    </div>

    <!-- 編集ダイアログ（モーダル） -->
    <div id="edit-dialog" class="modal hidden">
        <div class="modal-content">
            <h3>問題を編集</h3>
            <div class="edit-form">
                <div class="form-group">
                    <label>問題文</label>
                    <input type="text" id="edit-sentence" class="edit-input">
                </div>
                <div class="form-group">
                    <label>漢字</label>
                    <input type="text" id="edit-kanji" class="edit-input" readonly>
                </div>
                <div class="form-group">
                    <label>音読み（カタカナ）</label>
                    <input type="text" id="edit-onyomi" class="edit-input">
                </div>
                <div class="form-group">
                    <label>訓読み（ひらがな）</label>
                    <input type="text" id="edit-kunyomi" class="edit-input">
                </div>
            </div>
            <div class="modal-actions">
                <button id="save-question-btn" class="btn-primary">保存</button>
                <button id="cancel-edit-btn" class="btn-secondary">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- 🆕 アップデート通知バナー -->
    <div id="update-banner" class="update-banner hidden">
        <div class="update-content">
            <span class="update-icon">🔄</span>
            <span class="update-message">新しいバージョンが利用可能です！</span>
            <button id="update-btn" class="update-btn">更新する</button>
            <button id="dismiss-btn" class="dismiss-btn">×</button>
        </div>
    </div>

    <!-- 🆕 PWAインストールプロンプト -->
    <div id="install-banner" class="install-banner hidden">
        <div class="install-content">
            <span class="install-icon">📱</span>
            <span class="install-message">アプリとしてインストールできます</span>
            <button id="install-btn" class="install-btn">インストール</button>
            <button id="install-dismiss-btn" class="dismiss-btn">×</button>
        </div>
    </div>

    <script src="app.js"></script>
    
    <!-- PWA Service Worker登録 + アップデート通知 -->
    <script>
        // ==========================================
        // Service Worker 登録とアップデート検出
        // ==========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('✅ Service Worker登録成功:', registration.scope);
                        
                        // アップデート検出
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // 🆕 新しいバージョンが利用可能
                                    console.log('🔄 新しいバージョンが利用可能です');
                                    showUpdateBanner();
                                }
                            });
                        });
                        
                        // 定期的にアップデートをチェック（1時間ごと）
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000);
                    })
                    .catch(error => {
                        console.error('❌ Service Worker登録失敗:', error);
                    });
            });
        }
        
        // ==========================================
        // アップデート通知バナー
        // ==========================================
        function showUpdateBanner() {
            const banner = document.getElementById('update-banner');
            if (banner) {
                banner.classList.remove('hidden');
            }
        }
        
        function hideUpdateBanner() {
            const banner = document.getElementById('update-banner');
            if (banner) {
                banner.classList.add('hidden');
            }
        }
        
        // 更新ボタン
        document.getElementById('update-btn')?.addEventListener('click', () => {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                
                // ページをリロード
                setTimeout(() => {
                    window.location.reload();
                }, 100);
            }
        });
        
        // 閉じるボタン
        document.getElementById('dismiss-btn')?.addEventListener('click', () => {
            hideUpdateBanner();
        });
        
        // ==========================================
        // PWAインストールプロンプト
        // ==========================================
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('📱 PWAインストール可能');
            
            // インストールバナーを表示（初回のみ）
            const installDismissed = localStorage.getItem('install_prompt_dismissed');
            if (!installDismissed) {
                showInstallBanner();
            }
        });
        
        function showInstallBanner() {
            const banner = document.getElementById('install-banner');
            if (banner) {
                banner.classList.remove('hidden');
            }
        }
        
        function hideInstallBanner() {
            const banner = document.getElementById('install-banner');
            if (banner) {
                banner.classList.add('hidden');
            }
        }
        
        // インストールボタン
        document.getElementById('install-btn')?.addEventListener('click', async () => {
            if (!deferredPrompt) {
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            console.log(`📱 PWAインストール結果: ${outcome}`);
            
            deferredPrompt = null;
            hideInstallBanner();
        });
        
        // 閉じるボタン
        document.getElementById('install-dismiss-btn')?.addEventListener('click', () => {
            hideInstallBanner();
            localStorage.setItem('install_prompt_dismissed', 'true');
        });
        
        // インストール成功時
        window.addEventListener('appinstalled', () => {
            console.log('✅ PWAインストール成功');
            hideInstallBanner();
        });
    </script>
</body>
</html>
